<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Check-in Globe</title>
<style>
html,body{margin:0;background:transparent;overflow:hidden}
#globe{width:100vw;height:100vh}
.label{
  font: bold 18px Arial;
  color:#fff;
  background:rgba(0,0,0,.65);
  padding:8px 12px;
  border-radius:12px;
  box-shadow:0 0 12px rgba(255,204,0,.6);
}
</style>
</head>
<body>
<div id="globe"></div>

<script type="module">
import Globe from "https://esm.sh/globe.gl?bundle";

let highlightedKey = null;
let lastFlyTs = 0;
  
const globe = Globe()(document.getElementById("globe"))
  .backgroundColor("rgba(0,0,0,0)")
  .globeImageUrl("https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg")
  .pointAltitude(0.05)
  .pointRadius(d => (d && d.key === highlightedKey) ? 0.9 : 0.55)
  .pointColor(d => (d && d.key === highlightedKey) ? "#ffffff" : "#ffcc00")

  .pointLabel(d => {
    const el = document.createElement("div");
    el.className = "label";
    el.textContent = `${d.user} arrived: ${d.display.split(',').slice(0,3).join(', ')}`;
    return el;
  })
  .pointsData([]);

globe.controls().autoRotate = true;
globe.controls().autoRotateSpeed = 0.6;
globe.controls().enableZoom = false;


async function poll(){
  const r = await fetch("/pins?ts=" + Date.now(), { cache: "no-store" });
  const data = await r.json();

  // Build a fresh list of pins from the server (authoritative)
  const mapped = data.map(p => ({
    key: p.user,          // one pin per user (stable identity)
    user: p.user,
    display: p.display,
    lat: p.lat,
    lng: p.lon,
    ts: p.ts
  }));

  // Replace ALL pins on the globe in one go
  globe.pointsData(mapped);

  // Highlight + fly-to newest pin (optional, but you already want this)
  const newest = mapped[0];
  if (newest && Date.now() - lastFlyTs > 3000) {
    lastFlyTs = Date.now();

    highlightedKey = newest.key;
    setTimeout(() => {
      if (highlightedKey === newest.key) highlightedKey = null;
    }, 3000);

    globe.pointOfView(
      { lat: newest.lat, lng: newest.lng, altitude: 1.4 },
      1500
    );

    setTimeout(() => {
      globe.pointOfView({ altitude: 2.2 }, 1500);
    }, 2200);
  }
}


setInterval(poll,2000);
poll();
</script>
</body>
</html>
